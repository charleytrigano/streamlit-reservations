import streamlit as st
import pandas as pd
import numpy as np
import os
import calendar
from datetime import datetime, timedelta
import openpyxl

# ==========================
# üìå Constantes
# ==========================
DATA_FILE = "reservations.xlsx"
LOGO_FILE = "logo.png"

# couleurs par plateforme
PLATFORM_COLORS = {
    "Booking": "#1e90ff",
    "Airbnb": "#ff5a5f",
    "Abritel": "#f08080",
    "Autre": "#f59e0b",
}

# ==========================
# üìå Fonctions utilitaires
# ==========================
def load_data():
    if os.path.exists(DATA_FILE):
        return pd.read_excel(DATA_FILE)
    else:
        return pd.DataFrame(columns=[
            "Plateforme", "Nom du client", "Date arriv√©e", "Date d√©part",
            "Prix brut", "Commission", "Frais CB", "Prix net",
            "M√©nage", "Taxe s√©jour", "Base", "%", "Pay√©", "SMS"
        ])

def save_data(df):
    df.to_excel(DATA_FILE, index=False)

# formater une date
def format_date(d):
    if pd.isna(d):
        return ""
    return pd.to_datetime(d).strftime("%d/%m/%Y")

# ==========================
# üìå Vue : R√©servations
# ==========================
def vue_reservations(df: pd.DataFrame):
    st.header("üìã R√©servations")

    filtre_paye = st.radio("Filtrer pay√©", ["Tous", "Pay√©", "Non pay√©"], horizontal=True)
    if filtre_paye == "Pay√©":
        df = df[df["Pay√©"] == True]
    elif filtre_paye == "Non pay√©":
        df = df[df["Pay√©"] == False]

    plateforme_filtre = st.multiselect("Plateformes", options=df["Plateforme"].unique(), default=df["Plateforme"].unique())
    df = df[df["Plateforme"].isin(plateforme_filtre)]

    st.dataframe(df, use_container_width=True)

# ==========================
# üìå Vue : Calendrier
# ==========================
def vue_calendrier(df: pd.DataFrame):
    st.header("üìÖ Calendrier")

    # S√©lection du mois et de l'ann√©e
    today = datetime.today()
    col1, col2 = st.columns(2)
    mois = col1.selectbox("Mois", list(calendar.month_name)[1:], index=today.month-1)
    annee = col2.number_input("Ann√©e", value=today.year, step=1)

    mois_num = list(calendar.month_name).index(mois)
    cal = calendar.Calendar(firstweekday=0)

    jours = cal.monthdatescalendar(annee, mois_num)

    # Construire la grille
    grille = []
    for semaine in jours:
        ligne = []
        for jour in semaine:
            if jour.month != mois_num:
                ligne.append("")
            else:
                resa_jour = df[(pd.to_datetime(df["Date arriv√©e"]) <= jour) & (pd.to_datetime(df["Date d√©part"]) > jour)]
                if not resa_jour.empty:
                    contenu = ""
                    color = PLATFORM_COLORS.get(resa_jour.iloc[0]["Plateforme"], "#cccccc")
                    for _, r in resa_jour.iterrows():
                        contenu += f"<div style='background:{color};color:white;padding:2px;border-radius:4px;margin:1px'>{r['Nom du client']}</div>"
                    ligne.append(f"<b>{jour.day}</b><br>{contenu}")
                else:
                    ligne.append(str(jour.day))
        grille.append(ligne)

    # Afficher la grille avec st.markdown (HTML)
    table_html = "<table style='width:100%;border-collapse:collapse;text-align:center'>"
    jours_sem = ["Lun", "Mar", "Mer", "Jeu", "Ven", "Sam", "Dim"]
    table_html += "<tr>" + "".join([f"<th style='border:1px solid #ccc;padding:4px'>{j}</th>" for j in jours_sem]) + "</tr>"
    for semaine in grille:
        table_html += "<tr>" + "".join([f"<td style='border:1px solid #ccc;vertical-align:top;height:80px'>{c}</td>" for c in semaine]) + "</tr>"
    table_html += "</table>"

    st.markdown(table_html, unsafe_allow_html=True)

    # L√©gende
    st.subheader("üé® L√©gende plateformes")
    legende = ""
    for pf, color in PLATFORM_COLORS.items():
        legende += f"<span style='background:{color};color:white;padding:4px;border-radius:4px;margin-right:8px'>{pf}</span>"
    st.markdown(legende, unsafe_allow_html=True)


# ==========================
# üìå Normalisation & calculs
# ==========================
def to_date(x):
    if pd.isna(x) or x is None:
        return pd.NaT
    try:
        return pd.to_datetime(x).normalize()
    except Exception:
        return pd.NaT

def ensure_schema(df: pd.DataFrame) -> pd.DataFrame:
    cols = [
        "Plateforme", "Nom du client", "Date arriv√©e", "Date d√©part",
        "Prix brut", "Commission", "Frais CB", "Prix net",
        "M√©nage", "Taxe s√©jour", "Base", "%", "Pay√©", "SMS"
    ]
    for c in cols:
        if c not in df.columns:
            df[c] = np.nan

    # Types
    df["Plateforme"] = df["Plateforme"].fillna("Autre").astype(str)
    df["Nom du client"] = df["Nom du client"].fillna("").astype(str)
    df["Date arriv√©e"] = df["Date arriv√©e"].apply(to_date)
    df["Date d√©part"] = df["Date d√©part"].apply(to_date)
    num_cols = ["Prix brut","Commission","Frais CB","Prix net","M√©nage","Taxe s√©jour","Base","%"]
    for c in num_cols:
        df[c] = pd.to_numeric(df[c], errors="coerce").fillna(0.0)

    # Calculs
    df["Prix net"] = (df["Prix brut"] - df["Commission"] - df["Frais CB"]).clip(lower=0)
    df["Base"] = (df["Prix net"] - df["M√©nage"] - df["Taxe s√©jour"]).clip(lower=0)
    with pd.option_context("mode.use_inf_as_na", True):
        df["%"] = (df["Commission"] + df["Frais CB"]) / df["Prix brut"] * 100
    df["%"] = df["%"].fillna(0).round(2)

    # Bool
    df["Pay√©"] = df["Pay√©"].fillna(False).astype(bool)
    df["SMS"] = df["SMS"].fillna(False).astype(bool)

    # Tri par date
    df = df.sort_values(by=["Date arriv√©e","Nom du client"], na_position="last").reset_index(drop=True)
    return df


# ==========================
# üìå Vue : Ajouter
# ==========================
def vue_ajouter(df: pd.DataFrame):
    st.header("‚ûï Ajouter une r√©servation")

    c1, c2 = st.columns(2)
    plateforme = c1.selectbox("Plateforme", options=list(PLATFORM_COLORS.keys()), index=0)
    nom = c2.text_input("Nom du client")

    c3, c4 = st.columns(2)
    d1 = c3.date_input("Date arriv√©e", value=datetime.today().date())
    d2 = c4.date_input("Date d√©part", value=(datetime.today() + timedelta(days=1)).date(), min_value=d1 + timedelta(days=1))

    c5, c6, c7 = st.columns(3)
    brut = c5.number_input("Prix brut (‚Ç¨)", min_value=0.0, step=1.0)
    commission = c6.number_input("Commission (‚Ç¨)", min_value=0.0, step=1.0)
    frais_cb = c7.number_input("Frais CB (‚Ç¨)", min_value=0.0, step=1.0)

    c8, c9 = st.columns(2)
    menage = c8.number_input("M√©nage (‚Ç¨)", min_value=0.0, step=1.0)
    taxe = c9.number_input("Taxe s√©jour (‚Ç¨)", min_value=0.0, step=1.0)

    c10, c11 = st.columns(2)
    paye = c10.checkbox("Pay√©", value=False)
    sms = c11.checkbox("SMS envoy√©", value=False)

    if st.button("Enregistrer"):
        new_row = {
            "Plateforme": plateforme,
            "Nom du client": nom.strip(),
            "Date arriv√©e": pd.to_datetime(d1),
            "Date d√©part": pd.to_datetime(d2),
            "Prix brut": float(brut),
            "Commission": float(commission),
            "Frais CB": float(frais_cb),
            "Prix net": 0.0,  # recalcul√© par ensure_schema
            "M√©nage": float(menage),
            "Taxe s√©jour": float(taxe),
            "Base": 0.0,      # recalcul√©
            "%": 0.0,         # recalcul√©
            "Pay√©": bool(paye),
            "SMS": bool(sms)
        }
        df2 = pd.concat([df, pd.DataFrame([new_row])], ignore_index=True)
        df2 = ensure_schema(df2)
        save_data(df2)
        st.success("‚úÖ R√©servation ajout√©e.")
        st.experimental_rerun()


# ==========================
# üìå Vue : Modifier / Supprimer
# ==========================
def vue_modifier(df: pd.DataFrame):
    st.header("‚úèÔ∏è Modifier / Supprimer une r√©servation")
    if df.empty:
        st.info("Aucune r√©servation.")
        return

    df_show = df.copy()
    df_show["Arriv√©e"] = df_show["Date arriv√©e"].dt.strftime("%d/%m/%Y").fillna("")
    options = (df_show["Nom du client"] + " ‚Äî " + df_show["Plateforme"] + " ‚Äî " + df_show["Arriv√©e"]).tolist()
    choix = st.selectbox("Choisir une r√©servation", options)

    idx = options.index(choix)
    r = df.iloc[idx]

    c1, c2 = st.columns(2)
    plateforme = c1.selectbox("Plateforme", options=list(PLATFORM_COLORS.keys()), index=list(PLATFORM_COLORS.keys()).index(r["Plateforme"]) if r["Plateforme"] in PLATFORM_COLORS else 0)
    nom = c2.text_input("Nom du client", value=r["Nom du client"])

    c3, c4 = st.columns(2)
    d1 = c3.date_input("Date arriv√©e", value=r["Date arriv√©e"].date() if not pd.isna(r["Date arriv√©e"]) else datetime.today().date())
    d2 = c4.date_input("Date d√©part", value=r["Date d√©part"].date() if not pd.isna(r["Date d√©part"]) else (datetime.today()+timedelta(days=1)).date(), min_value=d1 + timedelta(days=1))

    c5, c6, c7 = st.columns(3)
    brut = c5.number_input("Prix brut (‚Ç¨)", min_value=0.0, step=1.0, value=float(r["Prix brut"]))
    commission = c6.number_input("Commission (‚Ç¨)", min_value=0.0, step=1.0, value=float(r["Commission"]))
    frais_cb = c7.number_input("Frais CB (‚Ç¨)", min_value=0.0, step=1.0, value=float(r["Frais CB"]))

    c8, c9 = st.columns(2)
    menage = c8.number_input("M√©nage (‚Ç¨)", min_value=0.0, step=1.0, value=float(r["M√©nage"]))
    taxe = c9.number_input("Taxe s√©jour (‚Ç¨)", min_value=0.0, step=1.0, value=float(r["Taxe s√©jour"]))

    c10, c11 = st.columns(2)
    paye = c10.checkbox("Pay√©", value=bool(r["Pay√©"]))
    sms = c11.checkbox("SMS envoy√©", value=bool(r["SMS"]))

    colA, colB = st.columns(2)
    if colA.button("üíæ Enregistrer les modifications"):
        df.at[idx, "Plateforme"] = plateforme
        df.at[idx, "Nom du client"] = nom.strip()
        df.at[idx, "Date arriv√©e"] = pd.to_datetime(d1)
        df.at[idx, "Date d√©part"] = pd.to_datetime(d2)
        df.at[idx, "Prix brut"] = float(brut)
        df.at[idx, "Commission"] = float(commission)
        df.at[idx, "Frais CB"] = float(frais_cb)
        df.at[idx, "M√©nage"] = float(menage)
        df.at[idx, "Taxe s√©jour"] = float(taxe)
        df.at[idx, "Pay√©"] = bool(paye)
        df.at[idx, "SMS"] = bool(sms)

        df = ensure_schema(df)
        save_data(df)
        st.success("‚úÖ Modifications enregistr√©es.")
        st.experimental_rerun()

    if colB.button("üóë Supprimer cette r√©servation"):
        df2 = df.drop(index=idx).reset_index(drop=True)
        save_data(ensure_schema(df2))
        st.warning("üóë R√©servation supprim√©e.")
        st.experimental_rerun()


# ==========================
# üìå Vue : Rapport
# ==========================
def vue_rapport(df: pd.DataFrame):
    st.header("üìä Rapport")
    if df.empty:
        st.info("Aucune donn√©e.")
        return

    df = ensure_schema(df)
    df["Ann√©e"] = df["Date arriv√©e"].dt.year
    df["Mois"] = df["Date arriv√©e"].dt.month

    c1, c2, c3 = st.columns(3)
    annees = sorted([int(x) for x in df["Ann√©e"].dropna().unique()])
    annee = c1.selectbox("Ann√©e", annees, index=len(annees)-1)
    pf_opt = ["Toutes"] + sorted(df["Plateforme"].dropna().unique().tolist())
    pf = c2.selectbox("Plateforme", pf_opt)
    mois_opt = ["Tous"] + [f"{i:02d}" for i in range(1,13)]
    mois_label = c3.selectbox("Mois", mois_opt)

    data = df[df["Ann√©e"] == int(annee)].copy()
    if pf != "Toutes":
        data = data[data["Plateforme"] == pf]
    if mois_label != "Tous":
        data = data[data["Mois"] == int(mois_label)]

    if data.empty:
        st.info("Aucune donn√©e pour ces filtres.")
        return

    # D√©tail
    show = data[[
        "Pay√©","Nom du client","Plateforme","Date arriv√©e","Date d√©part",
        "Prix brut","Commission","Frais CB","Prix net","M√©nage","Taxe s√©jour","Base","%"
    ]].copy()
    show["Date arriv√©e"] = show["Date arriv√©e"].dt.strftime("%d/%m/%Y")
    show["Date d√©part"] = show["Date d√©part"].dt.strftime("%d/%m/%Y")
    st.dataframe(show, use_container_width=True)

    # Totaux
    tot_brut = data["Prix brut"].sum()
    tot_net = data["Prix net"].sum()
    tot_base = data["Base"].sum()
    tot_com = (data["Commission"] + data["Frais CB"]).sum()
    colA, colB, colC, colD = st.columns(4)
    colA.metric("Total brut", f"{tot_brut:,.2f} ‚Ç¨")
    colB.metric("Total net", f"{tot_net:,.2f} ‚Ç¨")
    colC.metric("Base", f"{tot_base:,.2f} ‚Ç¨")
    colD.metric("Commissions + CB", f"{tot_com:,.2f} ‚Ç¨")

    # Export XLSX
    from io import BytesIO
    buf = BytesIO()
    with pd.ExcelWriter(buf, engine="openpyxl") as writer:
        show.to_excel(writer, index=False, sheet_name="Rapport")
    st.download_button(
        "‚¨áÔ∏è Export XLSX",
        data=buf.getvalue(),
        file_name=f"rapport_{annee}{'' if mois_label=='Tous' else '_'+mois_label}.xlsx",
        mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
    )


# ==========================
# üìå Vue : Clients
# ==========================
def vue_clients(df: pd.DataFrame):
    st.header("üë• Liste des clients")
    if df.empty:
        st.info("Aucune donn√©e.")
        return

    df = ensure_schema(df)
    show = df[[
        "Nom du client","Plateforme","Date arriv√©e","Date d√©part",
        "Prix brut","Prix net","Base","Pay√©"
    ]].copy()
    show["Date arriv√©e"] = show["Date arriv√©e"].dt.strftime("%d/%m/%Y")
    show["Date d√©part"] = show["Date d√©part"].dt.strftime("%d/%m/%Y")
    st.dataframe(show, use_container_width=True)

    st.download_button(
        "‚¨áÔ∏è Export CSV",
        data=show.to_csv(index=False).encode("utf-8"),
        file_name="clients.csv",
        mime="text/csv"
    )


# ==========================
# üìå Vue : Export ICS simple
# ==========================
def make_ics(df: pd.DataFrame) -> str:
    # ICS minimal (√©v√©nements all-day)
    lines = [
        "BEGIN:VCALENDAR",
        "VERSION:2.0",
        "PRODID:-//Villa Tobias//FR"
    ]
    for _, r in df.iterrows():
        if pd.isna(r["Date arriv√©e"]) or pd.isna(r["Date d√©part"]):
            continue
        d1 = pd.to_datetime(r["Date arriv√©e"]).strftime("%Y%m%d")
        d2 = pd.to_datetime(r["Date d√©part"]).strftime("%Y%m%d")
        title = f"{r['Plateforme']} - {r['Nom du client']}"
        lines += [
            "BEGIN:VEVENT",
            f"DTSTART;VALUE=DATE:{d1}",
            f"DTEND;VALUE=DATE:{d2}",
            f"SUMMARY:{title}",
            "END:VEVENT"